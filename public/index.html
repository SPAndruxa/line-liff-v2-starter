<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gigya login test</title>
  <!--link rel="stylesheet" href="./css/centralpage.css"/-->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EXR59WBGH8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EXR59WBGH8');
</script>
  <script type="text/javascript" src="https://cdns.gigya.com/js/gigya.js?apikey=3_ejiBpUKe3wdl5VAb7q-J1HSux9e5sgVsENViW6YLlBiJxs-XNuJt6YwpQAkvQTYt&lang=en">
    {
      include: "id_token"
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">
  <script defer src="https://use.fontawesome.com/releases/v5.0.0/js/all.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="liff-starter.js"></script>
  <style>
    body {
      font-family: Verdana, Arial;
    }
  </style>
</head>

<body>

  <!--<section class="section">
    <div class="container">
      <h1 class="title">
            Welcome to the site A
          </h1>
      <p class="subtitle">
        <strong>PMI</strong> Demo!
      </p>
      <p>
        <nav class="breadcrumb" aria-label="breadcrumbs">

        </nav>
      </p>
      <p>
        <a href="#" onclick="createUIDContainer();">Register</a>
        <br />
        <br />
        <a href="#" onclick="gigya.accounts.showScreenSet({screenSet:'test-ProfileUpdate'});">Show my Profile</a>
        <br />
        <br />
        <a href="#" onclick="gigya.accounts.showScreenSet({screenSet:'test-RegistrationLogin'});">Login</a>
      </p>
       <p>
        <br />
        <br />
        <br />
        <br />
        <a href="#" onclick="gigya.accounts.logout();">Logout</a>
      </p>
    </div>
  </section>-->
<section class="section">
    <div class="container">
      <h1 class="title">
            Welcome to the site A
          </h1>
      <p class="subtitle">
        <strong>PMI</strong> Demo!
      </p>
      <p>
        <a href="#" onclick='gigya.accounts.showScreenSet({screenSet: "DCE 2.0 - RegistrationLogin_V2",regToken: ev.regToken,startScreen: "Registration_Web_LINE",onAfterScreenLoad: afterScreenLoadHandler,onAfterSubmit: onAfterSubmitHandler,context: contextObj});'>Login</a>
      </p>
    </div>
  </section>
  <script>  
    $('a').on('click', function(e){
      console.log("click -> a");
      if ($(this).attr('')) e.preventDefault()
    })
    function createUIDContainer() {
      let username = Math.random().toString(36).substring(2);
      let password = Math.random().toString(36).substring(2);
      gigya.accounts.initRegistration({
        callback: function(e) {
          gigya.accounts.register({
            regToken: e.regToken,
            username: username,
            password: password,
            callback: function(ev) {
              function afterScreenLoadHandler(event) {
                document.getElementById("gigya-UID-label").innerHTML = "UID: " + event.context.UID;
                document.getElementById("gigya-completion-password").value = event.context.password;
              }

              function onAfterSubmitHandler(event) {
                //IF error=0 then we can call to finalizeRegistration
                gigya.accounts.finalizeRegistration({
                  regToken: event.response.requestParams.regToken
                });
              }
              
              var contextObj = {
                "UID": ev.userInfo.UID,
                "password": password
              };
              gigya.accounts.showScreenSet({
                screenSet: "test-RegistrationLogin",
                regToken: ev.regToken,
                startScreen: "gigya-complete-registration-screen",
                onAfterScreenLoad: afterScreenLoadHandler,
                onAfterSubmit: onAfterSubmitHandler,
                context: contextObj
              });
            }
          });
        }
      });
    }
    //gigya.showDebugUI();
    gigya.accounts.getAccountInfo({
      include: "preferences",
      callback: startHandler
    });

    function startHandler(response) {
      if (response.errorCode == 0) {
      } else {
        var params = {
          screenSet: 'Default-RegistrationLogin',
          startScreen: 'gigya-register-screen',
          customLang: gigya.thisScript.globalConf.customLang['fr-ch'],
          lang: 'en'
        };
        //gigya.accounts.showScreenSet(params);
      }
    }
    gigya.accounts.addEventHandlers({
      onLogin: onLoginHandler
    });

    function onLoginHandler(response) {
      console.log(response);
      sendWebhook(response);
      try {
        var xhr = new XMLHttpRequest();
        xhr.withCredentials = true;
        xhr.addEventListener("readystatechange", function () {
          if (this.readyState === 4) {
            console.log(this.responseText);
          }
        });
        var cookie = "myLIFFCookieName202103031322:" + response.UID + ":30";
          console.log(cookie);
        xhr.open("GET", "https://crw.pp.iqos.com/iqosrw/" + cookie, true);
        
        xhr.send();
        
        xhr.onload = function() {
          console.log("Загружено: " + xhr.status + " " + xhr.response);
        };

        xhr.onerror = function() { // происходит, только когда запрос совсем не получилось выполнить
          console.log("Ошибка соединения");
        };
      } catch (e) {
        Object.keys(e).forEach((key, i) => {
          console.log(key, e[key]);
        });
      }
      //closeWin();
    }
    //createUIDContainer();
    gigya.accounts.showScreenSet({screenSet:'test-RegistrationLogin'});
  </script>
</body>

</html>
